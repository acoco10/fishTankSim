<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="css/loading.css" type="text/css" rel="stylesheet">
    <meta charset="UTF-8">
</head>
<body>
<div class ="page-wrapper">
    <img src="images/fishfishfishLogo.png" alt="FishLogo" class="header-image"/>
    <div id="loadingScreen">
        <div class="sprite-loader"></div>
        <h1 style="color: #e2f0ef;">Loading...</h1>
    </div>
</div>
</body>

<canvas id="game" width="640" height="480"></canvas>

<script src="wasm_exec.js"></script>

<script>
    const base = `${window.location.protocol}//${window.location.host}`;
    const username = localStorage.getItem("username");
    const password = localStorage.getItem("password")

    const go = new Go();

    fetch('/get-wasm-url')
        .then(response => response.json())
        .then(data => {
            const wasmUrl = data.url; // Get the presigned URL
            // Fetch and instantiate the WebAssembly module
            WebAssembly.instantiateStreaming(fetch(wasmUrl), go.importObject)
                .then(result => {
                    console.log("WebAssembly module instantiated!");
                    go.run(result.instance);
                })
                .catch(err => {
                    console.error("Failed to execute WebAssembly:", err);
                });
        })
        .catch(err => {
            console.error("Error fetching presigned URL:", err);
        });


   /*
    WebAssembly.instantiate(fetch(wasmUrl), go.importObject)
        .then(async (result) => {
            await go.run(result.instance);
        })
        .catch(err => {
            console.error("Failed to instantiate WASM:", err);

    });*/
</script>
<script>
    window.saveGame = function (data) {
        fetch(`${base}/save`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, state: data })
        })
            .then(() => console.log("FishScene saved!"))
            .catch(err => {
                console.warn("Failed to save game:", err.message);
            });
    }
</script>
<script>
    window.loadSaveData = async function () {
        try{
        const res = await(
        fetch(`${base}/load`, {
            method: "POST",
            body: JSON.stringify({ username, password})
        }));
        return await res.json();
        } catch (err){
            console.warn("Failed to load game:", err.message);
            return null;
        }
    };

</script>

