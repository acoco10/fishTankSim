<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="css/loading.css" type="text/css" rel="stylesheet">
    <meta charset="UTF-8">
</head>
<body>
<div class ="page-wrapper">
    <img src="images/fishfishfishLogo.png" alt="FishLogo" class="header-image"/>
    <div id="loadingScreen">
        <div class="sprite-loader"></div>
        <h1 style="color: #e2f0ef;">Loading...</h1>
    </div>
</div>
</body>

<canvas id="game" width="640" height="480"></canvas>

<script src="wasm_exec.js"></script>

<script>
    let lastSaveTime = 0;
    const base = `${window.location.protocol}//${window.location.host}`;
    const username = localStorage.getItem("username");
    const password = localStorage.getItem("password");
    const herokuURL = "https://blooming-springs-06199-0958fad0a895.herokuapp.com"
    const isNewUser = JSON.parse(localStorage.getItem("newUser"));

    const go = new Go();

    WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject)
        .then(async (result) => {
            console.log("WebAssembly module instantiated!");
            await go.run(result.instance);
        })
        .catch(err => {
            console.error("Failed to execute WebAssembly:", err);
        });

   /*
    WebAssembly.instantiate(fetch(wasmUrl), go.importObject)
        .then(async (result) => {
            await go.run(result.instance);
        })
        .catch(err => {
            console.error("Failed to instantiate WASM:", err);

    });*/
</script>
<script>
    window.saveGame = function (data) {
        const now = Date.now();
        if (now - lastSaveTime < 1000) return; // throttle within 1 sec
        lastSaveTime = now;
        const payload = {
            username: username,
            game: JSON.parse(data)
        };

        console.log("save data received from web assembly game:", data)

        fetch(`${herokuURL}/save`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        })
            .then(() => console.log("FishScene save request sent to server successfully!"))
            .catch(err => {
                console.warn("Failed to save game:", err.message);
            });
    }
</script>
<script>
    window.loadSaveData = async function () {
        try{
        const res = await(
        fetch(`${herokuURL}/load`, {
            method: "POST",
            body: JSON.stringify({ username, password})
        }));
        return await res.json()
        } catch (err){
            console.warn("Failed to load game:", err.message);
            return null;
        }
    };

</script>

